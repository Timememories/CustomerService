<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reset Password - Emotion Pal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 品牌色系统一：低饱和度暖色系 */
        :root {
            --accent: #9F7AEA; /* 主强调色（淡紫） */
            --accent-light: #E8F4F8; /* 浅蓝背景 */
            --accent-secondary: #FDF2F8; /* 浅粉背景 */
            --text-main: #4A5568; /* 正文色 */
            --text-dark: #2c3e50; /* 深色文本 */
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
            --success: #34D399; /* 成功色 */
            --error: #F87171; /* 错误色 */
        }

        body {
            /* 替换为品牌渐变背景 */
            background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent-secondary) 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            padding-top: 40px;
            padding-bottom: 40px;
            color: var(--text-main);
        }

        .reset-card {
            background-color: #ffffff;
            border-radius: 20px; /* 更圆润的边角 */
            box-shadow: var(--shadow-soft);
            padding: 2.5rem;
            max-width: 480px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        /* 顶部品牌装饰条 */
        .reset-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, var(--accent), #805AD5);
        }

        .reset-card h1 {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            text-align: center;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        /* 品牌图标装饰 */
        .reset-card h1::before {
            content: "\f004";
            font-family: "Font Awesome 6 Free";
            font-weight: 600;
            color: var(--accent);
            font-size: 1.5rem;
        }

        .reset-card .sub-title {
            text-align: center;
            color: #64748B;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .reset-card .sub-title strong {
            color: var(--accent);
        }

        .form-control {
            border: 1px solid #E2E8F0;
            border-radius: 12px; /* 圆润输入框 */
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            color: var(--text-main);
        }

        .form-control:focus {
            border-color: var(--accent); /* 聚焦色改为品牌色 */
            box-shadow: 0 0 0 0.25rem rgba(159, 122, 234, 0.2); /* 柔和的聚焦阴影 */
            outline: none;
        }

        /* 密码强度提示样式 */
        .password-strength {
            height: 4px;
            border-radius: 2px;
            margin-top: 0.5rem;
            background-color: #E2E8F0;
            overflow: hidden;
            display: none;
        }

        .strength-bar {
            height: 100%;
            width: 0%;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        .strength-weak {
            background-color: var(--error);
            width: 33%;
        }

        .strength-medium {
            background-color: #FBBF24;
            width: 66%;
        }

        .strength-strong {
            background-color: var(--success);
            width: 100%;
        }

        .strength-text {
            font-size: 0.8rem;
            margin-top: 0.25rem;
            display: none;
        }

        .btn-primary {
            background-color: var(--accent); /* 按钮改为品牌色 */
            border: none;
            padding: 0.75rem;
            font-weight: 600;
            border-radius: 12px; /* 圆润按钮 */
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #805AD5; /* hover加深 */
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(159, 122, 234, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            background-color: #A78BFA;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }

        /* 提示消息样式 */
        .alert-message {
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
            display: none;
        }

        .alert-success {
            background-color: #ECFDF5;
            border: 1px solid var(--success);
            color: #065F46;
            display: block;
        }

        .alert-error {
            background-color: #FEF2F2;
            border: 1px solid var(--error);
            color: #991B1B;
            display: block;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* 标签小图标 */
        .form-label::before {
            content: "";
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: var(--accent);
        }

        /* 密码输入框容器 */
        .password-input-group {
            position: relative;
        }

        /* 密码显隐图标 */
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #94A3B8;
            transition: all 0.2s ease;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-toggle:hover {
            color: var(--accent);
            transform: translateY(-50%) scale(1.1);
        }

        /* 返回登录链接 */
        .back-to-login {
            display: block;
            text-align: center;
            margin-top: 1.5rem;
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .back-to-login:hover {
            text-decoration: underline;
            color: #805AD5;
        }

        /* 移动端适配 */
        @media (max-width: 576px) {
            .reset-card {
                padding: 2rem 1.5rem;
            }

            .reset-card h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="reset-card mx-auto">
            <h1>Reset Your Password</h1>
            <p class="sub-title">Setting new password for: <strong id="usernameDisplay">{{ username }}</strong></p>

            <!-- 提示消息框 -->
            <div id="alertMessage" class="alert-message"></div>

            <!-- 密码重置表单 -->
            <form id="resetPasswordForm" method="POST" action="/api/reset-password">
                <!-- 隐藏字段：传递用户名 -->
                <input type="hidden" name="username" value="{{ username }}">

                <!-- 新密码输入框 -->
                <div class="mb-4">
                    <label for="newPassword" class="form-label">New Password</label>
                    <div class="password-input-group">
                        <input type="password" id="newPassword" name="newPassword" class="form-control" required
                               placeholder="Enter your new password (min 8 chars)">
                        <i class="fas fa-eye password-toggle" id="newPasswordToggle"></i>
                    </div>
                    <!-- 密码强度提示 -->
                    <div class="password-strength" id="passwordStrengthBar"></div>
                    <span id="strengthText" class="strength-text"></span>
                </div>

                <!-- 确认密码输入框 -->
                <div class="mb-4">
                    <label for="confirmPassword" class="form-label">Confirm New Password</label>
                    <div class="password-input-group">
                        <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" required
                               placeholder="Confirm your new password">
                        <i class="fas fa-eye password-toggle" id="confirmPasswordToggle"></i>
                    </div>
                    <!-- 密码一致性提示 -->
                    <span id="passwordMatchText" class="text-sm mt-1 d-block" style="display: none;"></span>
                </div>

                <!-- 提交按钮 -->
                <button type="submit" class="btn btn-primary w-100" id="resetBtn">
                    Reset Password
                </button>
            </form>

            <!-- 返回登录链接 -->
            <a href="/login" class="back-to-login">
                <i class="fas fa-arrow-left me-1"></i> Back to Login
            </a>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 1. 密码显隐功能
            const newPasswordToggle = document.getElementById('newPasswordToggle');
            const confirmPasswordToggle = document.getElementById('confirmPasswordToggle');
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');

            // 新密码显隐切换
            newPasswordToggle.addEventListener('click', function() {
                togglePasswordVisibility(newPasswordInput, this);
            });

            // 确认密码显隐切换
            confirmPasswordToggle.addEventListener('click', function() {
                togglePasswordVisibility(confirmPasswordInput, this);
            });

            // 2. 密码强度检测
            newPasswordInput.addEventListener('input', function() {
                const password = this.value;
                const strengthBar = document.getElementById('passwordStrengthBar');
                const strengthText = document.getElementById('strengthText');

                if (password.length === 0) {
                    strengthBar.style.display = 'none';
                    strengthText.style.display = 'none';
                    return;
                }

                // 显示强度条和文本
                strengthBar.style.display = 'block';
                strengthText.style.display = 'block';

                // 检测密码强度
                const strength = calculatePasswordStrength(password);
                updateStrengthIndicator(strengthBar, strengthText, strength);
            });

            // 3. 密码一致性检测
            confirmPasswordInput.addEventListener('input', function() {
                const newPwd = newPasswordInput.value;
                const confirmPwd = this.value;
                const matchText = document.getElementById('passwordMatchText');

                if (confirmPwd.length === 0) {
                    matchText.style.display = 'none';
                    return;
                }

                matchText.style.display = 'block';
                if (newPwd === confirmPwd) {
                    matchText.textContent = '✅ Passwords match';
                    matchText.style.color = 'var(--success)';
                } else {
                    matchText.textContent = '❌ Passwords do not match';
                    matchText.style.color = 'var(--error)';
                }
            });

            // 4. 表单提交处理
            const resetForm = document.getElementById('resetPasswordForm');
            const resetBtn = document.getElementById('resetBtn');
            const alertMessage = document.getElementById('alertMessage');

            resetForm.addEventListener('submit', async function(e) {
                e.preventDefault(); // 阻止默认提交

                // 基础校验
                const newPwd = newPasswordInput.value;
                const confirmPwd = confirmPasswordInput.value;

                if (newPwd.length < 8) {
                    showAlert('Password must be at least 8 characters long!', false);
                    return;
                }

                if (newPwd !== confirmPwd) {
                    showAlert('Passwords do not match!', false);
                    return;
                }

                // 按钮加载状态
                resetBtn.disabled = true;
                resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Resetting...';

                try {
                    // 构建表单数据
                    const formData = new FormData(resetForm);

                    // 调用重置密码接口
                    const response = await fetch('/api/reset-password', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': getCSRFToken() // CSRF保护（如果启用）
                        }
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // 重置成功
                        showAlert('✅ Password reset successfully! Redirecting to login...', true);
                        // 3秒后跳转到登录页
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 3000);
                    } else {
                        // 重置失败
                        showAlert(data.message || 'Failed to reset password! Please try again.', false);
                    }
                } catch (error) {
                    // 网络错误
                    console.error('Reset password error:', error);
                    showAlert('Network error! Please check your connection.', false);
                } finally {
                    // 恢复按钮状态（仅当失败时）
                    if (!alertMessage.classList.contains('alert-success')) {
                        resetBtn.disabled = false;
                        resetBtn.innerHTML = 'Reset Password';
                    }
                }
            });

            // 辅助函数：切换密码可见性
            function togglePasswordVisibility(input, toggleIcon) {
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);
                // 切换图标
                toggleIcon.classList.toggle('fa-eye');
                toggleIcon.classList.toggle('fa-eye-slash');
            }

            // 辅助函数：计算密码强度
            function calculatePasswordStrength(password) {
                let score = 0;

                // 长度加分
                if (password.length >= 8) score += 1;
                if (password.length >= 12) score += 1;

                // 字符类型加分
                if (/[A-Z]/.test(password)) score += 1; // 大写字母
                if (/[a-z]/.test(password)) score += 1; // 小写字母
                if (/[0-9]/.test(password)) score += 1; // 数字
                if (/[^A-Za-z0-9]/.test(password)) score += 1; // 特殊字符

                // 返回强度等级：0-2=弱，3-4=中，5+=强
                if (score < 3) return 'weak';
                if (score < 5) return 'medium';
                return 'strong';
            }

            // 辅助函数：更新密码强度指示器
            function updateStrengthIndicator(bar, text, strength) {
                // 清除原有类
                bar.classList.remove('strength-weak', 'strength-medium', 'strength-strong');

                // 设置新样式
                switch(strength) {
                    case 'weak':
                        bar.classList.add('strength-weak');
                        text.textContent = 'Weak password (add uppercase, numbers or symbols)';
                        text.style.color = 'var(--error)';
                        break;
                    case 'medium':
                        bar.classList.add('strength-medium');
                        text.textContent = 'Medium password (add more characters or symbols)';
                        text.style.color = '#FBBF24';
                        break;
                    case 'strong':
                        bar.classList.add('strength-strong');
                        text.textContent = 'Strong password!';
                        text.style.color = 'var(--success)';
                        break;
                }
            }

            // 辅助函数：显示提示消息
            function showAlert(message, isSuccess) {
                alertMessage.textContent = message;
                alertMessage.classList.remove('alert-success', 'alert-error');
                alertMessage.classList.add(isSuccess ? 'alert-success' : 'alert-error');

                // 滚动到提示框
                alertMessage.scrollIntoView({ behavior: 'smooth' });
            }

            // 辅助函数：获取CSRF Token（适配Flask-WTF）
            function getCSRFToken() {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrf_token') {
                        return value;
                    }
                }
                return '';
            }

            // 5. 点击其他区域隐藏密码
            document.addEventListener('click', function(e) {
                // 新密码输入框
                if (!newPasswordToggle.contains(e.target) && !newPasswordInput.contains(e.target)) {
                    hidePassword(newPasswordInput, newPasswordToggle);
                }
                // 确认密码输入框
                if (!confirmPasswordToggle.contains(e.target) && !confirmPasswordInput.contains(e.target)) {
                    hidePassword(confirmPasswordInput, confirmPasswordToggle);
                }
            });

            // 辅助函数：隐藏密码
            function hidePassword(input, toggleIcon) {
                if (input.getAttribute('type') === 'text') {
                    input.setAttribute('type', 'password');
                    toggleIcon.classList.remove('fa-eye-slash');
                    toggleIcon.classList.add('fa-eye');
                }
            }
        });
    </script>
</body>
</html>